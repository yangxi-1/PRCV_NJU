<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33108845-1']);
  _gaq.push(['_setDomainName', 'opencv.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Face Recognition in Videos with OpenCV &mdash; OpenCV 2.4.13.7 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '2.4.13.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <link rel="top" title="OpenCV 2.4.13.7 documentation" href="../../../../../index.html" />
    <link rel="up" title="FaceRecognizer - Face Recognition with OpenCV" href="../index.html" />
    <link rel="next" title="Saving and Loading a FaceRecognizer" href="facerec_save_load.html" />
    <link rel="prev" title="Gender Classification with OpenCV" href="facerec_gender_classification.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="facerec_save_load.html" title="Saving and Loading a FaceRecognizer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="facerec_gender_classification.html" title="Gender Classification with OpenCV"
             accesskey="P">previous</a> |</li>
        <li><a href="../../../../../index.html">OpenCV 2.4.13.7 documentation</a> &raquo;</li>
          <li><a href="../../../../refman.html" >OpenCV API Reference</a> &raquo;</li>
          <li><a href="../../contrib.html" >contrib. Contributed/Experimental Stuff</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">FaceRecognizer - Face Recognition with OpenCV</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
  
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="face-recognition-in-videos-with-opencv">
<h1><a class="toc-backref" href="#id1">Face Recognition in Videos with OpenCV</a><a class="headerlink" href="#face-recognition-in-videos-with-opencv" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#face-recognition-in-videos-with-opencv" id="id1">Face Recognition in Videos with OpenCV</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#prerequisites" id="id3">Prerequisites</a></li>
<li><a class="reference internal" href="#face-recongition-from-videos" id="id4">Face Recongition from Videos</a></li>
<li><a class="reference internal" href="#running-the-demo" id="id5">Running the Demo</a></li>
<li><a class="reference internal" href="#results" id="id6">Results</a></li>
<li><a class="reference internal" href="#appendix" id="id7">Appendix</a><ul>
<li><a class="reference internal" href="#creating-the-csv-file" id="id8">Creating the CSV File</a></li>
<li><a class="reference internal" href="#aligning-face-images" id="id9">Aligning Face Images</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Whenever you hear the term <em>face recognition</em>, you instantly think of surveillance in videos. So performing face recognition in videos (e.g. webcam) is one of the most requested features I have got. I have heard your cries, so here it is. An application, that shows you how to do face recognition in videos! For the face detection part we&#8217;ll use the awesome <a class="reference internal" href="../../../../objdetect/doc/cascade_classification.html#CascadeClassifier" title="class CascadeClassifier"><code class="xref ocv ocv-class docutils literal"><span class="pre">CascadeClassifier</span></code></a> and we&#8217;ll use <a class="reference internal" href="../facerec_api.html#FaceRecognizer : public Algorithm" title="class FaceRecognizer : public Algorithm"><code class="xref ocv ocv-class docutils literal"><span class="pre">FaceRecognizer</span></code></a> for face recognition. This example uses the Fisherfaces method for face recognition, because it is robust against large changes in illumination.</p>
<p>Here is what the final application looks like. As you can see I am only writing the id of the recognized person above the detected face (by the way this id is Arnold Schwarzenegger for my data set):</p>
<a class="reference internal image-reference" href="../../../../../_images/facerec_video.png"><img alt="../../../../../_images/facerec_video.png" class="align-center" src="../../../../../_images/facerec_video.png" /></a>
<p>This demo is a basis for your research and it shows you how to implement face recognition in videos. You probably want to extend the application and make it more sophisticated: You could combine the id with the name, then show the confidence of the prediction, recognize the emotion... and and and. But before you send mails, asking what these Haar-Cascade thing is or what a CSV is: Make sure you have read the entire tutorial. It&#8217;s all explained in here. If you just want to scroll down to the code, please note:</p>
<ul class="simple">
<li>The available Haar-Cascades for face detection are located in the <code class="docutils literal"><span class="pre">data</span></code> folder of your OpenCV installation! One of the available Haar-Cascades for face detection is for example <code class="docutils literal"><span class="pre">/path/to/opencv/data/haarcascades/haarcascade_frontalface_default.xml</span></code>.</li>
</ul>
<p>I encourage you to experiment with the application. Play around with the available <a class="reference internal" href="../facerec_api.html#FaceRecognizer : public Algorithm" title="class FaceRecognizer : public Algorithm"><code class="xref ocv ocv-class docutils literal"><span class="pre">FaceRecognizer</span></code></a> implementations, try the available cascades in OpenCV and see if you can improve your results!</p>
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id3">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>You want to do face recognition, so you need some face images to learn a <a class="reference internal" href="../facerec_api.html#FaceRecognizer : public Algorithm" title="class FaceRecognizer : public Algorithm"><code class="xref ocv ocv-class docutils literal"><span class="pre">FaceRecognizer</span></code></a> on. I have decided to reuse the images from the gender classification example: <a class="reference internal" href="facerec_gender_classification.html"><em>Gender Classification with OpenCV</em></a>.</p>
<p>I have the following celebrities in my training data set:</p>
<ul class="simple">
<li>Angelina Jolie</li>
<li>Arnold Schwarzenegger</li>
<li>Brad Pitt</li>
<li>George Clooney</li>
<li>Johnny Depp</li>
<li>Justin Timberlake</li>
<li>Katy Perry</li>
<li>Keanu Reeves</li>
<li>Patrick Stewart</li>
<li>Tom Cruise</li>
</ul>
<p>In the demo I have decided to read the images from a very simple CSV file. Why? Because it&#8217;s the simplest platform-independent approach I can think of. However, if you know a simpler solution please ping me about it. Basically all the CSV file needs to contain are lines composed of a <code class="docutils literal"><span class="pre">filename</span></code> followed by a <code class="docutils literal"><span class="pre">;</span></code> followed by the <code class="docutils literal"><span class="pre">label</span></code> (as <em>integer number</em>), making up a line like this:</p>
<div class="highlight-none"><div class="highlight"><pre>/path/to/image.ext;0
</pre></div>
</div>
<p>Let&#8217;s dissect the line. <code class="docutils literal"><span class="pre">/path/to/image.ext</span></code> is the path to an image, probably something like this if you are in Windows: <code class="docutils literal"><span class="pre">C:/faces/person0/image0.jpg</span></code>. Then there is the separator <code class="docutils literal"><span class="pre">;</span></code> and finally we assign a label <code class="docutils literal"><span class="pre">0</span></code> to the image. Think of the label as the subject (the person, the gender or whatever comes to your mind). In the face recognition scenario, the label is the person this image belongs to. In the gender classification scenario, the label is the gender the person has. So my CSV file looks like this:</p>
<div class="highlight-none"><div class="highlight"><pre>/home/philipp/facerec/data/c/keanu_reeves/keanu_reeves_01.jpg;0
/home/philipp/facerec/data/c/keanu_reeves/keanu_reeves_02.jpg;0
/home/philipp/facerec/data/c/keanu_reeves/keanu_reeves_03.jpg;0
...
/home/philipp/facerec/data/c/katy_perry/katy_perry_01.jpg;1
/home/philipp/facerec/data/c/katy_perry/katy_perry_02.jpg;1
/home/philipp/facerec/data/c/katy_perry/katy_perry_03.jpg;1
...
/home/philipp/facerec/data/c/brad_pitt/brad_pitt_01.jpg;2
/home/philipp/facerec/data/c/brad_pitt/brad_pitt_02.jpg;2
/home/philipp/facerec/data/c/brad_pitt/brad_pitt_03.jpg;2
...
/home/philipp/facerec/data/c1/crop_arnold_schwarzenegger/crop_08.jpg;6
/home/philipp/facerec/data/c1/crop_arnold_schwarzenegger/crop_05.jpg;6
/home/philipp/facerec/data/c1/crop_arnold_schwarzenegger/crop_02.jpg;6
/home/philipp/facerec/data/c1/crop_arnold_schwarzenegger/crop_03.jpg;6
</pre></div>
</div>
<p>All images for this example were chosen to have a frontal face perspective. They have been cropped, scaled and rotated to be aligned at the eyes, just like this set of George Clooney images:</p>
<img alt="../../../../../_images/clooney_set.png" class="align-center" src="../../../../../_images/clooney_set.png" />
</div>
<div class="section" id="face-recongition-from-videos">
<h2><a class="toc-backref" href="#id4">Face Recongition from Videos</a><a class="headerlink" href="#face-recongition-from-videos" title="Permalink to this headline">¶</a></h2>
<p>The source code for the demo is available in the <code class="docutils literal"><span class="pre">src</span></code> folder coming with this documentation:</p>
<ul class="simple">
<li><a class="reference download internal" href="../../../../../_downloads/facerec_video.cpp" download=""><code class="xref download docutils literal"><span class="pre">src/facerec_video.cpp</span></code></a></li>
</ul>
<p>This demo uses the <a class="reference internal" href="../../../../objdetect/doc/cascade_classification.html#CascadeClassifier" title="class CascadeClassifier"><code class="xref ocv ocv-class docutils literal"><span class="pre">CascadeClassifier</span></code></a>:</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2011. Philipp Wagner &lt;bytefish[at]gmx[dot]de&gt;.</span>
<span class="cm"> * Released to public domain under terms of the BSD Simplified license.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *   * Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *   * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *   * Neither the name of the organization nor the names of its contributors</span>
<span class="cm"> *     may be used to endorse or promote products derived from this software</span>
<span class="cm"> *     without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> *   See &lt;http://www.opensource.org/licenses/bsd-license&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&quot;opencv2/core/core.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;opencv2/contrib/contrib.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;opencv2/highgui/highgui.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;opencv2/imgproc/imgproc.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;opencv2/objdetect/objdetect.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">read_csv</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat</span><span class="o">&gt;&amp;</span> <span class="n">images</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">labels</span><span class="p">,</span> <span class="kt">char</span> <span class="n">separator</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">ifstream</span><span class="o">::</span><span class="n">in</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">string</span> <span class="n">error_message</span> <span class="o">=</span> <span class="s">&quot;No valid input file was given, please check the given filename.&quot;</span><span class="p">;</span>
        <span class="n">CV_Error</span><span class="p">(</span><span class="n">CV_StsBadArg</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">string</span> <span class="n">line</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">classlabel</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">stringstream</span> <span class="n">liness</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">liness</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">separator</span><span class="p">);</span>
        <span class="n">getline</span><span class="p">(</span><span class="n">liness</span><span class="p">,</span> <span class="n">classlabel</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">classlabel</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">images</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
            <span class="n">labels</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">classlabel</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">// Check for valid command line arguments, print usage</span>
    <span class="c1">// if no arguments were given.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &lt;/path/to/haar_cascade&gt; &lt;/path/to/csv.ext&gt; &lt;/path/to/device id&gt;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> &lt;/path/to/haar_cascade&gt; -- Path to the Haar Cascade for face detection.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> &lt;/path/to/csv.ext&gt; -- Path to the CSV file with the face database.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> &lt;device id&gt; -- The webcam device id to grab frames from.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Get the path to your CSV:</span>
    <span class="n">string</span> <span class="n">fn_haar</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">string</span> <span class="n">fn_csv</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="kt">int</span> <span class="n">deviceId</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="c1">// These vectors hold the images and corresponding labels:</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="n">images</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">labels</span><span class="p">;</span>
    <span class="c1">// Read in the data (fails if no valid input filename is given, but you&#39;ll get an error message):</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">read_csv</span><span class="p">(</span><span class="n">fn_csv</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error opening file </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">fn_csv</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">. Reason: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="c1">// nothing more we can do</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Get the height from the first image. We&#39;ll need this</span>
    <span class="c1">// later in code to reshape the images to their original</span>
    <span class="c1">// size AND we need to reshape incoming faces to this size:</span>
    <span class="kt">int</span> <span class="n">im_width</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cols</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">im_height</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rows</span><span class="p">;</span>
    <span class="c1">// Create a FaceRecognizer and train it on the given images:</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">FaceRecognizer</span><span class="o">&gt;</span> <span class="n">model</span> <span class="o">=</span> <span class="n">createFisherFaceRecognizer</span><span class="p">();</span>
    <span class="n">model</span><span class="o">-&gt;</span><span class="n">train</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">);</span>
    <span class="c1">// That&#39;s it for learning the Face Recognition model. You now</span>
    <span class="c1">// need to create the classifier for the task of Face Detection.</span>
    <span class="c1">// We are going to use the haar cascade you have specified in the</span>
    <span class="c1">// command line arguments:</span>
    <span class="c1">//</span>
    <span class="n">CascadeClassifier</span> <span class="n">haar_cascade</span><span class="p">;</span>
    <span class="n">haar_cascade</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn_haar</span><span class="p">);</span>
    <span class="c1">// Get a handle to the Video device:</span>
    <span class="n">VideoCapture</span> <span class="nf">cap</span><span class="p">(</span><span class="n">deviceId</span><span class="p">);</span>
    <span class="c1">// Check if we can use this device at all:</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cap</span><span class="p">.</span><span class="n">isOpened</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Capture Device ID &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">deviceId</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;cannot be opened.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Holds the current frame from the Video device:</span>
    <span class="n">Mat</span> <span class="n">frame</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="n">frame</span><span class="p">;</span>
        <span class="c1">// Clone the current frame:</span>
        <span class="n">Mat</span> <span class="n">original</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
        <span class="c1">// Convert the current frame to grayscale:</span>
        <span class="n">Mat</span> <span class="n">gray</span><span class="p">;</span>
        <span class="n">cvtColor</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="n">CV_BGR2GRAY</span><span class="p">);</span>
        <span class="c1">// Find the faces in the frame:</span>
        <span class="n">vector</span><span class="o">&lt;</span> <span class="n">Rect_</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">faces</span><span class="p">;</span>
        <span class="n">haar_cascade</span><span class="p">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">faces</span><span class="p">);</span>
        <span class="c1">// At this point you have the position of the faces in</span>
        <span class="c1">// faces. Now we&#39;ll get the faces, make a prediction and</span>
        <span class="c1">// annotate it in the video. Cool or what?</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">faces</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Process face by face:</span>
            <span class="n">Rect</span> <span class="n">face_i</span> <span class="o">=</span> <span class="n">faces</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="c1">// Crop the face from the image. So simple with OpenCV C++:</span>
            <span class="n">Mat</span> <span class="n">face</span> <span class="o">=</span> <span class="n">gray</span><span class="p">(</span><span class="n">face_i</span><span class="p">);</span>
            <span class="c1">// Resizing the face is necessary for Eigenfaces and Fisherfaces. You can easily</span>
            <span class="c1">// verify this, by reading through the face recognition tutorial coming with OpenCV.</span>
            <span class="c1">// Resizing IS NOT NEEDED for Local Binary Patterns Histograms, so preparing the</span>
            <span class="c1">// input data really depends on the algorithm used.</span>
            <span class="c1">//</span>
            <span class="c1">// I strongly encourage you to play around with the algorithms. See which work best</span>
            <span class="c1">// in your scenario, LBPH should always be a contender for robust face recognition.</span>
            <span class="c1">//</span>
            <span class="c1">// Since I am showing the Fisherfaces algorithm here, I also show how to resize the</span>
            <span class="c1">// face you have just found:</span>
            <span class="n">Mat</span> <span class="n">face_resized</span><span class="p">;</span>
            <span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">face_resized</span><span class="p">,</span> <span class="n">Size</span><span class="p">(</span><span class="n">im_width</span><span class="p">,</span> <span class="n">im_height</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">INTER_CUBIC</span><span class="p">);</span>
            <span class="c1">// Now perform the prediction, see how easy that is:</span>
            <span class="kt">int</span> <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">predict</span><span class="p">(</span><span class="n">face_resized</span><span class="p">);</span>
            <span class="c1">// And finally write all we&#39;ve found out to the original image!</span>
            <span class="c1">// First of all draw a green rectangle around the detected face:</span>
            <span class="n">rectangle</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">face_i</span><span class="p">,</span> <span class="n">CV_RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
            <span class="c1">// Create the text we will annotate the box with:</span>
            <span class="n">string</span> <span class="n">box_text</span> <span class="o">=</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;Prediction = %d&quot;</span><span class="p">,</span> <span class="n">prediction</span><span class="p">);</span>
            <span class="c1">// Calculate the position for annotated text (make sure we don&#39;t</span>
            <span class="c1">// put illegal values in there):</span>
            <span class="kt">int</span> <span class="n">pos_x</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">face_i</span><span class="p">.</span><span class="n">tl</span><span class="p">().</span><span class="n">x</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">pos_y</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">face_i</span><span class="p">.</span><span class="n">tl</span><span class="p">().</span><span class="n">y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="c1">// And now put it into the image:</span>
            <span class="n">putText</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">box_text</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span><span class="p">),</span> <span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">CV_RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// Show the result:</span>
        <span class="n">imshow</span><span class="p">(</span><span class="s">&quot;face_recognizer&quot;</span><span class="p">,</span> <span class="n">original</span><span class="p">);</span>
        <span class="c1">// And display it:</span>
        <span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">waitKey</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="c1">// Exit this loop on escape:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="running-the-demo">
<h2><a class="toc-backref" href="#id5">Running the Demo</a><a class="headerlink" href="#running-the-demo" title="Permalink to this headline">¶</a></h2>
<p>You&#8217;ll need:</p>
<ul class="simple">
<li>The path to a valid Haar-Cascade for detecting a face with a <a class="reference internal" href="../../../../objdetect/doc/cascade_classification.html#CascadeClassifier" title="class CascadeClassifier"><code class="xref ocv ocv-class docutils literal"><span class="pre">CascadeClassifier</span></code></a>.</li>
<li>The path to a valid CSV File for learning a <a class="reference internal" href="../facerec_api.html#FaceRecognizer : public Algorithm" title="class FaceRecognizer : public Algorithm"><code class="xref ocv ocv-class docutils literal"><span class="pre">FaceRecognizer</span></code></a>.</li>
<li>A webcam and its device id (you don&#8217;t know the device id? Simply start from 0 on and see what happens).</li>
</ul>
<p>If you are in Windows, then simply start the demo by running (from command line):</p>
<div class="highlight-none"><div class="highlight"><pre>facerec_video.exe &lt;C:/path/to/your/haar_cascade.xml&gt; &lt;C:/path/to/your/csv.ext&gt; &lt;video device&gt;
</pre></div>
</div>
<p>If you are in Linux, then simply start the demo by running:</p>
<div class="highlight-none"><div class="highlight"><pre>./facerec_video &lt;/path/to/your/haar_cascade.xml&gt; &lt;/path/to/your/csv.ext&gt; &lt;video device&gt;
</pre></div>
</div>
<p>An example. If the haar-cascade is at <code class="docutils literal"><span class="pre">C:/opencv/data/haarcascades/haarcascade_frontalface_default.xml</span></code>, the CSV file is at <code class="docutils literal"><span class="pre">C:/facerec/data/celebrities.txt</span></code> and I have a webcam with deviceId <code class="docutils literal"><span class="pre">1</span></code>, then I would call the demo with:</p>
<div class="highlight-none"><div class="highlight"><pre>facerec_video.exe C:/opencv/data/haarcascades/haarcascade_frontalface_default.xml C:/facerec/data/celebrities.txt 1
</pre></div>
</div>
<p>That&#8217;s it.</p>
</div>
<div class="section" id="results">
<h2><a class="toc-backref" href="#id6">Results</a><a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
<p>Enjoy!</p>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id7">Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-the-csv-file">
<h3><a class="toc-backref" href="#id8">Creating the CSV File</a><a class="headerlink" href="#creating-the-csv-file" title="Permalink to this headline">¶</a></h3>
<p>You don&#8217;t really want to create the CSV file by hand. I have prepared you a little Python script <code class="docutils literal"><span class="pre">create_csv.py</span></code> (you find it at <code class="docutils literal"><span class="pre">/src/create_csv.py</span></code> coming with this tutorial) that automatically creates you a CSV file. If you have your images in hierarchie like this (<code class="docutils literal"><span class="pre">/basepath/&lt;subject&gt;/&lt;image.ext&gt;</span></code>):</p>
<div class="highlight-none"><div class="highlight"><pre>philipp@mango:~/facerec/data/at$ tree
.
|-- s1
|   |-- 1.pgm
|   |-- ...
|   |-- 10.pgm
|-- s2
|   |-- 1.pgm
|   |-- ...
|   |-- 10.pgm
...
|-- s40
|   |-- 1.pgm
|   |-- ...
|   |-- 10.pgm
</pre></div>
</div>
<p>Then simply call <code class="docutils literal"><span class="pre">create_csv.py</span></code> with the path to the folder, just like this and you could save the output:</p>
<div class="highlight-none"><div class="highlight"><pre>philipp@mango:~/facerec/data$ python create_csv.py
at/s13/2.pgm;0
at/s13/7.pgm;0
at/s13/6.pgm;0
at/s13/9.pgm;0
at/s13/5.pgm;0
at/s13/3.pgm;0
at/s13/4.pgm;0
at/s13/10.pgm;0
at/s13/8.pgm;0
at/s13/1.pgm;0
at/s17/2.pgm;1
at/s17/7.pgm;1
at/s17/6.pgm;1
at/s17/9.pgm;1
at/s17/5.pgm;1
at/s17/3.pgm;1
[...]
</pre></div>
</div>
<p>Here is the script, if you can&#8217;t find it:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="c1"># This is a tiny script to help you creating a CSV file from a face</span>
<span class="c1"># database with a similar hierarchie:</span>
<span class="c1">#</span>
<span class="c1">#  philipp@mango:~/facerec/data/at$ tree</span>
<span class="c1">#  .</span>
<span class="c1">#  |-- README</span>
<span class="c1">#  |-- s1</span>
<span class="c1">#  |   |-- 1.pgm</span>
<span class="c1">#  |   |-- ...</span>
<span class="c1">#  |   |-- 10.pgm</span>
<span class="c1">#  |-- s2</span>
<span class="c1">#  |   |-- 1.pgm</span>
<span class="c1">#  |   |-- ...</span>
<span class="c1">#  |   |-- 10.pgm</span>
<span class="c1">#  ...</span>
<span class="c1">#  |-- s40</span>
<span class="c1">#  |   |-- 1.pgm</span>
<span class="c1">#  |   |-- ...</span>
<span class="c1">#  |   |-- 10.pgm</span>
<span class="c1">#</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;usage: create_csv &lt;base_path&gt;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">BASE_PATH</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">SEPARATOR</span><span class="o">=</span><span class="s2">&quot;;&quot;</span>

    <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subdirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="n">subject_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">subdirname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">subject_path</span><span class="p">):</span>
                <span class="n">abs_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subject_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;</span><span class="si">%s%s%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="n">SEPARATOR</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="aligning-face-images">
<h3><a class="toc-backref" href="#id9">Aligning Face Images</a><a class="headerlink" href="#aligning-face-images" title="Permalink to this headline">¶</a></h3>
<p>An accurate alignment of your image data is especially important in tasks like emotion detection, were you need as much detail as possible. Believe me... You don&#8217;t want to do this by hand. So I&#8217;ve prepared you a tiny Python script. The code is really easy to use. To scale, rotate and crop the face image you just need to call <em>CropFace(image, eye_left, eye_right, offset_pct, dest_sz)</em>, where:</p>
<ul class="simple">
<li><em>eye_left</em> is the position of the left eye</li>
<li><em>eye_right</em> is the position of the right eye</li>
<li><em>offset_pct</em> is the percent of the image you want to keep next to the eyes (horizontal, vertical direction)</li>
<li><em>dest_sz</em> is the size of the output image</li>
</ul>
<p>If you are using the same <em>offset_pct</em> and <em>dest_sz</em> for your images, they are all aligned at the eyes.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89</pre></div></td><td class="code"><div class="highlight"><pre><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Software License Agreement (BSD License)</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2012, Philipp Wagner</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions</span>
<span class="c1"># are met:</span>
<span class="c1">#</span>
<span class="c1">#  * Redistributions of source code must retain the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer.</span>
<span class="c1">#  * Redistributions in binary form must reproduce the above</span>
<span class="c1">#    copyright notice, this list of conditions and the following</span>
<span class="c1">#    disclaimer in the documentation and/or other materials provided</span>
<span class="c1">#    with the distribution.</span>
<span class="c1">#  * Neither the name of the author nor the names of its</span>
<span class="c1">#    contributors may be used to endorse or promote products derived</span>
<span class="c1">#    from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1"># &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1"># LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<span class="c1"># COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="c1"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="c1"># BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="c1"># LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<span class="c1"># ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">Image</span>

<span class="k">def</span> <span class="nf">Distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>
  <span class="n">dx</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">dy</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ScaleRotateTranslate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">new_center</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scale</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
  <span class="n">nx</span><span class="p">,</span><span class="n">ny</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">center</span>
  <span class="n">sx</span><span class="o">=</span><span class="n">sy</span><span class="o">=</span><span class="mf">1.0</span>
  <span class="k">if</span> <span class="n">new_center</span><span class="p">:</span>
    <span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_center</span>
  <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
    <span class="p">(</span><span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
  <span class="n">cosine</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
  <span class="n">sine</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">cosine</span><span class="o">/</span><span class="n">sx</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">sine</span><span class="o">/</span><span class="n">sx</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">nx</span><span class="o">*</span><span class="n">a</span><span class="o">-</span><span class="n">ny</span><span class="o">*</span><span class="n">b</span>
  <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">sine</span><span class="o">/</span><span class="n">sy</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">cosine</span><span class="o">/</span><span class="n">sy</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">nx</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">ny</span><span class="o">*</span><span class="n">e</span>
  <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">AFFINE</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">f</span><span class="p">),</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">CropFace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">eye_left</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">eye_right</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">offset_pct</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">dest_sz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">70</span><span class="p">,</span><span class="mi">70</span><span class="p">)):</span>
  <span class="c1"># calculate offsets in original image</span>
  <span class="n">offset_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">offset_pct</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">dest_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">offset_v</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">offset_pct</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dest_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="c1"># get the direction</span>
  <span class="n">eye_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">eye_right</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">eye_left</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eye_right</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">eye_left</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="c1"># calc rotation angle in radians</span>
  <span class="n">rotation</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">eye_direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">eye_direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="c1"># distance between them</span>
  <span class="n">dist</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="n">eye_left</span><span class="p">,</span> <span class="n">eye_right</span><span class="p">)</span>
  <span class="c1"># calculate the reference eye-width</span>
  <span class="n">reference</span> <span class="o">=</span> <span class="n">dest_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">offset_h</span>
  <span class="c1"># scale factor</span>
  <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
  <span class="c1"># rotate original around the left eye</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">ScaleRotateTranslate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">eye_left</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
  <span class="c1"># crop the rotated image</span>
  <span class="n">crop_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">eye_left</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="o">*</span><span class="n">offset_h</span><span class="p">,</span> <span class="n">eye_left</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="o">*</span><span class="n">offset_v</span><span class="p">)</span>
  <span class="n">crop_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">scale</span><span class="p">,</span> <span class="n">dest_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">scale</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">crop_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
  <span class="c1"># resize it</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">dest_sz</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">image</span> <span class="o">=</span>  <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;arnie.jpg&quot;</span><span class="p">)</span>
  <span class="n">CropFace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">eye_left</span><span class="o">=</span><span class="p">(</span><span class="mi">252</span><span class="p">,</span><span class="mi">364</span><span class="p">),</span> <span class="n">eye_right</span><span class="o">=</span><span class="p">(</span><span class="mi">420</span><span class="p">,</span><span class="mi">366</span><span class="p">),</span> <span class="n">offset_pct</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">dest_sz</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;arnie_10_10_200_200.jpg&quot;</span><span class="p">)</span>
  <span class="n">CropFace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">eye_left</span><span class="o">=</span><span class="p">(</span><span class="mi">252</span><span class="p">,</span><span class="mi">364</span><span class="p">),</span> <span class="n">eye_right</span><span class="o">=</span><span class="p">(</span><span class="mi">420</span><span class="p">,</span><span class="mi">366</span><span class="p">),</span> <span class="n">offset_pct</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">dest_sz</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;arnie_20_20_200_200.jpg&quot;</span><span class="p">)</span>
  <span class="n">CropFace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">eye_left</span><span class="o">=</span><span class="p">(</span><span class="mi">252</span><span class="p">,</span><span class="mi">364</span><span class="p">),</span> <span class="n">eye_right</span><span class="o">=</span><span class="p">(</span><span class="mi">420</span><span class="p">,</span><span class="mi">366</span><span class="p">),</span> <span class="n">offset_pct</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">dest_sz</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;arnie_30_30_200_200.jpg&quot;</span><span class="p">)</span>
  <span class="n">CropFace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">eye_left</span><span class="o">=</span><span class="p">(</span><span class="mi">252</span><span class="p">,</span><span class="mi">364</span><span class="p">),</span> <span class="n">eye_right</span><span class="o">=</span><span class="p">(</span><span class="mi">420</span><span class="p">,</span><span class="mi">366</span><span class="p">),</span> <span class="n">offset_pct</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;arnie_20_20_70_70.jpg&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Imagine we are given <a class="reference external" href="http://en.wikipedia.org/wiki/File:Arnold_Schwarzenegger_edit%28ws%29.jpg">this photo of Arnold Schwarzenegger</a>, which is under a Public Domain license. The (x,y)-position of the eyes is approximately <em>(252,364)</em> for the left and <em>(420,366)</em> for the right eye. Now you only need to define the horizontal offset, vertical offset and the size your scaled, rotated &amp; cropped face should have.</p>
<p>Here are some examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Configuration</th>
<th class="head">Cropped, Scaled, Rotated Face</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0.1 (10%), 0.1 (10%), (200,200)</td>
<td><img alt="../../../../../_images/arnie_10_10_200_2001.jpg" class="first last" src="../../../../../_images/arnie_10_10_200_2001.jpg" />
</td>
</tr>
<tr class="row-odd"><td>0.2 (20%), 0.2 (20%), (200,200)</td>
<td><img alt="../../../../../_images/arnie_20_20_200_2001.jpg" class="first last" src="../../../../../_images/arnie_20_20_200_2001.jpg" />
</td>
</tr>
<tr class="row-even"><td>0.3 (30%), 0.3 (30%), (200,200)</td>
<td><img alt="../../../../../_images/arnie_30_30_200_2001.jpg" class="first last" src="../../../../../_images/arnie_30_30_200_2001.jpg" />
</td>
</tr>
<tr class="row-odd"><td>0.2 (20%), 0.2 (20%), (70,70)</td>
<td><img alt="../../../../../_images/arnie_20_20_70_701.jpg" class="first last" src="../../../../../_images/arnie_20_20_70_701.jpg" />
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
          <div class="feedback">
              <h2>Help and Feedback</h2>
              You did not find what you were looking for?
              <ul>
                  
                  
                  
                  <li>Ask a question on the <a href="http://answers.opencv.org">Q&A forum</a>.</li>
                  <li>If you think something is missing or wrong in the documentation,
                  please file a <a href="http://code.opencv.org">bug report</a>.</li>
              </ul>
          </div>
        </div>
      </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/opencv-logo-white.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
      <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Search" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
      </p>
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="../../../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Face Recognition in Videos with OpenCV</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#face-recongition-from-videos">Face Recongition from Videos</a></li>
<li><a class="reference internal" href="#running-the-demo">Running the Demo</a></li>
<li><a class="reference internal" href="#results">Results</a></li>
<li><a class="reference internal" href="#appendix">Appendix</a><ul>
<li><a class="reference internal" href="#creating-the-csv-file">Creating the CSV File</a></li>
<li><a class="reference internal" href="#aligning-face-images">Aligning Face Images</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="facerec_gender_classification.html"
                        title="previous chapter">Gender Classification with OpenCV</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="facerec_save_load.html"
                        title="next chapter">Saving and Loading a FaceRecognizer</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../../_sources/modules/contrib/doc/facerec/tutorial/facerec_video_recognition.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="facerec_save_load.html" title="Saving and Loading a FaceRecognizer"
             >next</a> |</li>
        <li class="right" >
          <a href="facerec_gender_classification.html" title="Gender Classification with OpenCV"
             >previous</a> |</li>
        <li><a href="../../../../../index.html">OpenCV 2.4.13.7 documentation</a> &raquo;</li>
          <li><a href="../../../../refman.html" >OpenCV API Reference</a> &raquo;</li>
          <li><a href="../../contrib.html" >contrib. Contributed/Experimental Stuff</a> &raquo;</li>
          <li><a href="../index.html" >FaceRecognizer - Face Recognition with OpenCV</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-2014, opencv dev team.
      Last updated on Jul 12, 2018.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>